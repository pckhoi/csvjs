/* global eprint, eprintKill */

import Papa from 'papaparse'

import Benchmark from './benchmark'
import Reader from '../src/reader'
import csvBase64 from './players_20.csv'
import { base64ToArrayBuffer, timeExecution } from './utils'

const buffer = base64ToArrayBuffer(csvBase64)
const file = new File([buffer], 'players_20.csv')

const benchmarkCSVData = `x,y,z,w
x,y,z,
x,y,,
x,,,
,,,
"x","y","z","w"
"x","y","z",""
"x","y","",""
"x","","",""
"","","",""
`

const largeFieldsCSVData = `xxxxxxxxxxxxxxxx,yyyyyyyyyyyyyyyy,zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz,wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww,vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
xxxxxxxxxxxxxxxxxxxxxxxx,yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy,zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz,wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww,vvvv
,,zzzz,wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww,vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx,yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy,zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz,wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww,vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
`.repeat(3)

const suite = new Benchmark.Suite('Reader')

suite
  .add('CSVJS.Reader', async () => {
    const r = new Reader(benchmarkCSVData)
    await r.readAll(() => {})
  })
  .add('CSVJS.Reader#largeFields', async () => {
    const r = new Reader(largeFieldsCSVData)
    await r.readAll(() => {})
  })
  .on('cycle', function(event) {
    eprint(String(event.target))
  })
  .on('complete', async () => {
    const str = await file.text()
    await timeExecution('Read players_20.csv with CSV.js', async () => {
      const r = new Reader(str)
      let i = 0
      await r.readAll(() => {
        i++
      })
      if (i !== 18279) {
        throw new Error(`unexpected number of rows ${i}`)
      }
    })
    await timeExecution(
      'Read players_20.csv with PapaParse',
      () =>
        new Promise(resolve => {
          Papa.parse(file, {
            complete: results => {
              if (results.data.length !== 18280) {
                throw new Error(`unexpected number of rows ${results.data.length}`)
              }
              resolve()
            },
          })
        })
    )
    eprintKill()
  })
  .run({
    async: true,
  })
